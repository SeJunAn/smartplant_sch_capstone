<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI Smart Pot</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <!-- ìƒë‹¨ ì œëª© -->
  <h1>ğŸŒ± ì•ˆì„¸ì¤€ í† ë§ˆí†  ğŸŒ±</h1>

  <!-- í™”ë¶„ ìƒíƒœ ì˜ì—­ -->
  <div class="pot-section">
    <img src="/static/images/pot_healthy.png" alt="í™”ë¶„ ìƒíƒœ" class="pot-img">
    <p class="status">{{ status }}</p>
  </div>

  <!-- ì„¼ì„œ ë°ì´í„° ì¹´ë“œ ì˜ì—­ -->
  <div class="sensor-cards">
    <!-- ì˜¨ë„ -->
    <div class="card">
      <img src="/static/images/icon_temperature.png" alt="Temperature" class="sensor-icon">
      <p class="label">Temperature</p>
      <p class="value">{{ temperature }} Â°C</p>
    </div>

    <!-- í† ì–‘ ìˆ˜ë¶„ -->
    <div class="card">
      <img src="/static/images/icon_moisture.png" alt="Moisture" class="sensor-icon">
      <p class="label">Moisture</p>
      <p class="value">{{ moisture }} %</p>
    </div>

    <!-- ê³µê¸° ìŠµë„ -->
    <div class="card">
      <img src="/static/images/icon_humidity.png" alt="Humidity" class="sensor-icon">
      <p class="label">Humidity</p>
      <p class="value">{{ humidity }} %</p>
    </div>

    <!-- ì¡°ë„ -->
    <div class="card">
      <img src="/static/images/icon_light.png" alt="Light" class="sensor-icon">
      <p class="label">Light</p>
      <p class="value">{{ light }} lux</p>
    </div>
  </div>

  <!-- ë§ˆì§€ë§‰ ê¸‰ìˆ˜ ì‹œê°„ -->
  <p class="last-water">ë§ˆì§€ë§‰ ê¸‰ìˆ˜: {{ last_watered }}</p>
  <!-- âœ… ìˆ˜ë™ ê¸‰ìˆ˜ ë²„íŠ¼ -->
  <button id="water-btn" class="water-btn" type="button">ğŸ’§ ìˆ˜ë™ ê¸‰ìˆ˜</button>
  <div id="pump-status" class="pump-status" aria-live="polite"></div>

  <script>
    const pumpButton = document.getElementById("water-btn");
    const pumpEndpoint = "http://192.168.223.55:5000/pump";
    const pumpLogEndpoint = "/pump-log/";
    const pumpStatusContainer = document.getElementById("pump-status");

    function logPumpStatus(message, variant = "info") {
      if (!pumpStatusContainer) {
        console.log(`[${variant}] ${message}`);
        return;
      }

      const entry = document.createElement("p");
      entry.className = `pump-status__entry pump-status__entry--${variant}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

      pumpStatusContainer.prepend(entry);

      const maxEntries = 5;
      while (pumpStatusContainer.childElementCount > maxEntries) {
        pumpStatusContainer.removeChild(pumpStatusContainer.lastElementChild);
      }
    }

    async function triggerPump() {
      pumpButton.disabled = true;
      pumpButton.textContent = "â³ ê¸‰ìˆ˜ ì¤‘...";
      logPumpStatus("ìë™ ê¸‰ìˆ˜ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.");

      try {
        const response = await fetch(pumpEndpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ triggeredAt: new Date().toISOString() }),
        });

        if (!response.ok) {
          throw new Error(`Pump server responded with ${response.status}`);
        }

        pumpButton.textContent = "âœ… ê¸‰ìˆ˜ ì™„ë£Œ";
        logPumpStatus("ì™¸ë¶€ íŒí”„ ì„œë²„ì—ì„œ ì„±ê³µ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.", "success");

        try {
          const pumpLogResponse = await fetch(pumpLogEndpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ start_time: new Date().toISOString() }),
          });

          if (!pumpLogResponse.ok) {
            throw new Error(`Pump log API responded with ${pumpLogResponse.status}`);
          }

          logPumpStatus("ë‚´ë¶€ íŒí”„ ë¡œê·¸ì— ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.", "success");
        } catch (logError) {
          console.error("Failed to log pump event:", logError);
          logPumpStatus("íŒí”„ ë¡œê·¸ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.", "warning");
        }
      } catch (error) {
        console.error("Failed to trigger pump:", error);
        pumpButton.textContent = "âš ï¸ ê¸‰ìˆ˜ ì‹¤íŒ¨";
        alert("ìë™ ê¸‰ìˆ˜ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        logPumpStatus(`ìë™ ê¸‰ìˆ˜ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, "error");
      } finally {
        setTimeout(() => {
          pumpButton.disabled = false;
          pumpButton.textContent = "ğŸ’§ ìˆ˜ë™ ê¸‰ìˆ˜";
        }, 3000);
      }
    }

    pumpButton.addEventListener("click", triggerPump);
  </script>
</body>
</html>
